"""
UHPPOTE request packet encoder unit tests.

Tests the packet encoding functions.
"""

import datetime
import unittest

# pylint: disable=import-error
from ipaddress import IPv4Address
from uhppoted import encode

from uhppoted.structs import Card
from uhppoted.structs import TimeProfile
from uhppoted.structs import Weekdays
from uhppoted.structs import TimeSegment


class TestEncode(unittest.TestCase):
    """
    Test suite for the message encoder.
    """

    def test_set_listener_request(self):
        """
        Tests message encoding for a set-listener request without an auto-send interval.
        """
        # fmt: off
        expected = bytearray([
            0x17, 0x90, 0x00, 0x00, 0x78, 0x37, 0x2a, 0x18, 0xc0, 0xa8, 0x01, 0x64, 0x61, 0xea, 0x0f, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        ])
        # fmt: on

        request = encode.set_listener_request(405419896, IPv4Address("192.168.1.100"), 60001, 15)

        self.assertEqual(request, expected)

    def test_set_listener_request_without_interval(self):
        """
        Tests message encoding for a set-listener request without an auto-send interval.
        """
        # fmt: off
        expected = bytearray([
            0x17, 0x90, 0x00, 0x00, 0x78, 0x37, 0x2a, 0x18, 0xc0, 0xa8, 0x01, 0x64, 0x61, 0xea, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        ])
        # fmt: on

        request = encode.set_listener_request(405419896, IPv4Address("192.168.1.100"), 60001)

        self.assertEqual(request, expected)

    def test_put_card_record_request(self):
        """
        Tests message encoding for a put-card-record request.
        """
        # fmt: off
        expected = bytearray([
            0x17, 0x50, 0x00, 0x00, 0x78, 0x37, 0x2a, 0x18, 0xa0, 0x7a, 0x99, 0x00, 0x20, 0x25, 0x01, 0x01,
            0x20, 0x25, 0x12, 0x31, 0x01, 0x00, 0x11, 0x01, 0x3f, 0x42, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        ])
        # fmt: on

        card = Card(
            10058400,
            datetime.date(2025, 1, 1),
            datetime.date(2025, 12, 31),
            {
                1: 1,
                3: 17,
                4: 1,
            },
            999999,
        )

        request = encode.put_card_record_request(405419896, card)

        self.assertEqual(request, expected)

    def test_set_time_profile_record_request(self):
        """
        Tests message encoding for a set-time-profile-record request.
        """
        # fmt: off
        expected = bytearray([
           0x17, 0x88, 0x00, 0x00, 0x78, 0x37, 0x2a, 0x18, 0x25, 0x20, 0x24, 0x11, 0x26, 0x20, 0x24, 0x12,
           0x29, 0x01, 0x01, 0x00, 0x01, 0x00, 0x01, 0x01, 0x08, 0x30, 0x09, 0x45, 0x11, 0x35, 0x13, 0x15,
           0x14, 0x01, 0x17, 0x59, 0x13, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
           0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        ])
        # fmt: on

        profile = TimeProfile(
            id=37,
            start_date=datetime.date(2024, 11, 26),
            end_date=datetime.date(2024, 12, 29),
            weekdays=Weekdays(
                monday=True,
                tuesday=True,
                thursday=True,
                saturday=True,
                sunday=True,
            ),
            segments={
                1: TimeSegment(datetime.time(8, 30), datetime.time(9, 45)),
                2: TimeSegment(datetime.time(11, 35), datetime.time(13, 15)),
                3: TimeSegment(datetime.time(14, 1), datetime.time(17, 59)),
            },
            linked_profile=19,
        )

        request = encode.set_time_profile_record_request(405419896, profile)

        self.assertEqual(request, expected)

    def test_get_antipassback_request(self):
        """
        Tests message encoding for a get-antipassback request.
        """
        # fmt: off
        expected = bytearray([
            0x17, 0x86, 0x00, 0x00, 0x78, 0x37, 0x2a, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        ])
        # fmt: on

        request = encode.get_antipassback_request(405419896)

        self.assertEqual(request, expected)

    def test_set_antipassback_request(self):
        """
        Tests message encoding for a set-antipassback request.
        """
        # fmt: off
        expected = bytearray([
            0x17, 0x84, 0x00, 0x00, 0x78, 0x37, 0x2a, 0x18, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        ])
        # fmt: on

        request = encode.set_antipassback_request(405419896, 2)

        self.assertEqual(request, expected)

    def test_restore_default_parameters_request(self):
        """
        Tests message encoding for a restore-default-parameters request.
        """
        # fmt: off
        expected = bytearray([
            0x17, 0xc8, 0x00, 0x00, 0x78, 0x37, 0x2a, 0x18, 0x55, 0xaa, 0xaa, 0x55, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
            0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        ])
        # fmt: on

        request = encode.restore_default_parameters_request(405419896)

        self.assertEqual(request, expected)


if __name__ == "__main__":
    unittest.main()
